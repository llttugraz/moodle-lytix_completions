define("lytix_completions/activity_completion",["exports","core/templates","lytix_helper/widget","lytix_logs/logs"],(function(_exports,_templates,_widget,_logs){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_templates=_interopRequireDefault(_templates),_widget=_interopRequireDefault(_widget);var log,widgetId="activity-completion",view={entries:[],filters:[]},rowsByModule={},elements={tableContainer:null,tbody:null,entryElements:null},currentCriterium="name",currentlyDescending=!0,sortingFunctions={name:function(a,b){return a.name.localeCompare(b.name)*(currentlyDescending?1:-1)},module:function(a,b){return a.module.localeCompare(b.module)*(currentlyDescending?1:-1)},open:function(a,b){return currentlyDescending?a.open<b.open:a.open>b.open},done:function(a,b){return currentlyDescending?a.open>b.open:a.open<b.open}},sort=function(){var criterium=arguments.length>0&&void 0!==arguments[0]?arguments[0]:currentCriterium,descending=arguments.length>1&&void 0!==arguments[1]?arguments[1]:currentlyDescending;currentCriterium=criterium,currentlyDescending=descending;for(var sortedData=Array.from(view.entries).sort(sortingFunctions[criterium]),hiddenElements=[],length=sortedData.length,i=0;i<length;++i){var row=sortedData[i].element;row.hidden?hiddenElements.push(row):elements.tbody.appendChild(row)}for(var _i=hiddenElements.length-1;_i>=0;--_i)elements.tbody.appendChild(hiddenElements[_i])},hide=function(element){elements.tbody.appendChild(element),element.setAttribute("hidden","")},reveal=function(element){return element.removeAttribute("hidden")},filter=function(module,isVisible){for(var elements=rowsByModule[module],action=isVisible?reveal:hide,i=elements.length-1;i>=0;--i)action(elements[i]);isVisible&&sort()};_exports.init=function(userid,contextid,courseid){var dataPromise=_widget.default.getData("lytix_completions_activity_completion_get",{contextid:contextid,courseid:courseid}).then((function(data){var count=data.Name.length;if(count>0)return data.count=count,data;throw new _widget.default.NoDataError})),stringsPromise=_widget.default.getStrings({lytix_completions:{identical:["forum","grade","submission","resource","quiz","video","bbb","label","feedback","assign"]}});elements.tableContainer=document.getElementById("activity-completion-table"),log=(0,_logs.makeLoggingFunction)(userid,courseid,contextid,"activity completion"),Promise.all([stringsPromise,dataPromise]).then((function(values){for(var strings=values[0],data=values[1],addCsvDownload=function addCsvDownload(event){var _this=this;event.preventDefault(),_templates.default.render("lytix_completions/activity_completion_csv",view).then((function(csv){var csvData=new Blob([csv],{type:"text/plain;charset=utf-8"});_this.href=window.URL.createObjectURL(csvData),_this.target="_blank",_this.download="<Statistic_>"+(new Date).toLocaleDateString()+".csv",_this.removeEventListener("click",addCsvDownload),_this.click(),log("DOWNLOAD","CSV")}))},count=data.count,entries=view.entries,hiddenModules=["label"],hiddenModulesSet=new Set(hiddenModules),i=0;i<count;++i){var module=data.Module[i],type=strings[module],done=data.Done[i],total=done+data.Open[i];view.entries.push({type:type,module:module,id:data.Id[i],name:data.Name[i],total:total,donePercentage:100*done/total,done:done,open:data.Open[i]}),rowsByModule.hasOwnProperty(module)||(rowsByModule[module]=[],view.filters.push({id:widgetId+"-filter-"+module,module:module,hidden:hiddenModulesSet.has(module),label:type}))}return view.filters.sort((function(a,b){return a.label<b.label?-1:a.label>b.label?1:0})),_templates.default.render("lytix_completions/activity_completion",view).then((function(html){elements.tableContainer.innerHTML=html,elements.tbody=document.getElementById("activity-completion-entries"),elements.entryElements=elements.tbody.getElementsByTagName("tr");for(var _i2=entries.length-1;_i2>=0;--_i2){var element=entries[_i2].element=elements.entryElements[_i2];rowsByModule[entries[_i2].module].push(element)}for(var _i3=hiddenModules.length-1;_i3>=0;--_i3){var _module=hiddenModules[_i3];rowsByModule.hasOwnProperty(_module)&&filter(_module,!1)}elements.tableContainer.removeAttribute("hidden");var currentlySortedBy=document.querySelector("#activity-completion-head .sorted");document.getElementById("activity-completion-head").addEventListener("click",(function(event){for(var _currentlySortedBy,th=event.target,criterium=th.dataset.criterium;!criterium&&th!==this;)criterium=(th=th.parentElement).dataset.criterium;if(criterium){null===(_currentlySortedBy=currentlySortedBy)||void 0===_currentlySortedBy||_currentlySortedBy.classList.remove("sorted"),(currentlySortedBy=th).classList.add("sorted");var descending="descending"!=th.dataset.order;th.dataset.order=descending?"descending":"ascending",sort(criterium,descending),log("SORT",descending?"DESC":"ASC",criterium)}})),document.getElementById("activity-filter").addEventListener("change",(function(event){filter(event.target.dataset.module,event.target.checked),log("FILTER","ON",event.target.dataset.module)})),document.getElementById("export-table-button").addEventListener("click",addCsvDownload),sort("module",!0)}))})).finally((function(){document.getElementById(widgetId).classList.remove("loading")})).catch((function(error){return _widget.default.handleError(error,widgetId)}))}}));

//# sourceMappingURL=activity_completion.min.js.map